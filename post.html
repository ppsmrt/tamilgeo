<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TamilGeo - Post</title>

  <!-- ‚úÖ Tailwind CSS + Typography -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {}
      },
      plugins: []
    }
  </script>

  <!-- ‚úÖ Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- ‚úÖ Custom Styles -->
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">
  <!-- ‚úÖ Shared Header -->
  <div id="shared-header"></div>

  <!-- ‚úÖ Post Container -->
  <main class="max-w-3xl mx-auto p-4 flex-grow" id="post-container">
    <p class="text-gray-500 italic">Loading post...</p>
  </main>

  <!-- ‚úÖ Back to Top Button -->
  <div class="fixed bottom-4 right-4">
    <button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-blue-700 transition">
      ‚Üë Top
    </button>
  </div>

  <!-- ‚úÖ Shared Footer -->
  <footer id="footer" class="mt-10"></footer>

  <!-- ‚úÖ Firebase & Blog Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDt86oFFa-h04TsfMWSFGe3UHw26WYoR-U",
      authDomain: "tamilgeoapp.firebaseapp.com",
      databaseURL: "https://tamilgeoapp-default-rtdb.firebaseio.com",
      projectId: "tamilgeoapp",
      storageBucket: "tamilgeoapp.appspot.com",
      messagingSenderId: "1092623024431",
      appId: "1:1092623024431:web:ea455dd68a9fcf480be1da"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const postId = new URLSearchParams(window.location.search).get("id");
    const container = document.getElementById("post-container");

    if (!postId) {
      container.innerHTML = "<p class='text-red-500'>Invalid Post ID.</p>";
      throw new Error("Missing post ID");
    }

    const postURL = `https://public-api.wordpress.com/wp/v2/sites/tamilgeo.wordpress.com/posts/${postId}`;

    fetch(postURL)
      .then(res => {
        if (!res.ok) throw new Error("Failed to fetch post");
        return res.json();
      })
      .then(post => {
        const featuredImage = post.jetpack_featured_media_url
          ? `<div class="aspect-video mb-4 rounded-md overflow-hidden"><img src="${post.jetpack_featured_media_url}" class="w-full h-full object-cover" alt="Featured Image"></div>`
          : "";

        const contentStyled = post.content.rendered
          .replace(/<blockquote>(.*?)<\/blockquote>/gs, '<blockquote class="border-l-4 border-green-600 bg-green-50 text-green-800 italic pl-4 py-2 my-4 rounded-md">$1</blockquote>')
          .replace(/<hr\s*\/?>/g, '<div class="my-8 border-t-2 border-dashed border-gray-300"></div>')
          .replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, '<pre class="bg-gray-900 text-white rounded-lg overflow-auto p-4 text-sm mt-4 mb-4">$1</pre>');

        const daysAgo = formatDaysAgo(post.date);
        const pageUrl = encodeURIComponent(window.location.href);
        const postTitle = encodeURIComponent(post.title.rendered);

        container.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-md">
            ${featuredImage}
            <h1 class="text-3xl font-bold mb-3 text-green-700">${post.title.rendered}</h1>
            <div class="text-sm text-gray-500 mb-6">
              üë§ TamilGeo &nbsp;|&nbsp; üóìÔ∏è ${daysAgo}
            </div>

            <article class="prose prose-green prose-lg max-w-none leading-relaxed">
              ${contentStyled}
            </article>

            <div class="mt-8 flex flex-wrap items-center gap-3">
              <button id="like-btn" class="bg-pink-500 text-white px-3 py-1 rounded-full hover:bg-pink-600">
                ‚ô• Like (<span id="like-count">0</span>)
              </button>
              <a href="https://wa.me/?text=${postTitle}%20${pageUrl}" target="_blank" class="bg-green-500 text-white px-3 py-1 rounded-full hover:bg-green-600">
                <i class="fab fa-whatsapp"></i>
              </a>
              <a href="https://www.facebook.com/sharer/sharer.php?u=${pageUrl}" target="_blank" class="bg-blue-700 text-white px-3 py-1 rounded-full hover:bg-blue-800">
                <i class="fab fa-facebook-f"></i>
              </a>
              <a href="https://twitter.com/intent/tweet?text=${postTitle}&url=${pageUrl}" target="_blank" class="bg-blue-400 text-white px-3 py-1 rounded-full hover:bg-blue-500">
                <i class="fab fa-twitter"></i>
              </a>
            </div>

            <div class="mt-10">
              <h2 class="font-semibold text-xl text-gray-800 mb-4">üí¨ Leave a Comment</h2>
              <form id="comment-form" class="space-y-3">
                <input type="text" id="comment-name" placeholder="Your Name" class="w-full p-2 border border-gray-300 rounded" required />
                <input type="email" id="comment-email" placeholder="Your Email" class="w-full p-2 border border-gray-300 rounded" required />
                <textarea id="comment-box" placeholder="Write a comment..." class="w-full p-2 border border-gray-300 rounded" required></textarea>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Post Comment</button>
              </form>

              <div id="comments" class="mt-6 space-y-4"></div>
            </div>
          </div>
        `;

        setupFirebase();
      })
      .catch(err => {
        console.error(err);
        container.innerHTML = "<p class='text-red-600 font-semibold'>Post not found or failed to load.</p>";
      });

    function formatDaysAgo(dateStr) {
      const postDate = new Date(dateStr);
      const now = new Date();
      const diffDays = Math.floor((now - postDate) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) return "Today";
      if (diffDays === 1) return "1 day ago";
      return `${diffDays} days ago`;
    }

    function formatTimestamp(ts) {
      const date = new Date(ts);
      return date.toLocaleTimeString("en-IN", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      }) + " ¬∑ " + date.toLocaleDateString("en-IN", {
        day: "2-digit",
        month: "short",
        year: "numeric"
      });
    }

    function setupFirebase() {
      const likeBtn = document.getElementById("like-btn");
      const likeCountSpan = document.getElementById("like-count");
      const commentForm = document.getElementById("comment-form");
      const commentsDiv = document.getElementById("comments");

      const likesRef = ref(db, `likes/post_${postId}`);
      const commentsRef = ref(db, `comments/post_${postId}`);

      onValue(likesRef, snapshot => {
        likeCountSpan.textContent = snapshot.val() || 0;
      });

      likeBtn.addEventListener("click", () => {
        get(likesRef).then(snapshot => {
          const currentLikes = snapshot.val() || 0;
          set(likesRef, currentLikes + 1);
        });
      });

      onValue(commentsRef, snapshot => {
        commentsDiv.innerHTML = "";
        const data = snapshot.val();
        if (data) {
          Object.values(data).forEach(comment => {
            const time = comment.timestamp ? formatTimestamp(comment.timestamp) : "Just now";
            commentsDiv.innerHTML += `
              <div class="bg-gray-50 p-3 border border-gray-200 rounded">
                <div class="flex justify-between items-center text-sm">
                  <span class="font-semibold text-green-700">${comment.name}</span>
                  <span class="text-gray-500">${time}</span>
                </div>
                <div class="text-sm mt-1 text-gray-800">${comment.message}</div>
              </div>`;
          });
        }
      });

      commentForm.addEventListener("submit", e => {
        e.preventDefault();
        const name = document.getElementById("comment-name").value.trim();
        const email = document.getElementById("comment-email").value.trim();
        const message = document.getElementById("comment-box").value.trim();

        if (name && email && message) {
          push(commentsRef, {
            name,
            email,
            message,
            timestamp: Date.now()
          });
          commentForm.reset();
        }
      });
    }
  </script>

  <!-- ‚úÖ Load Shared Header and Footer -->
  <script type="module" src="header.js"></script>
  <script type="module" src="js/footer.js"></script>
</body>
</html>
