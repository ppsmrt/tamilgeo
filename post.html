<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TamilGeo - Post</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, get, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDt86oFFa-h04TsfMWSFGe3UHw26WYoR-U",
      authDomain: "tamilgeoapp.firebaseapp.com",
      databaseURL: "https://tamilgeoapp-default-rtdb.firebaseio.com",
      projectId: "tamilgeoapp",
      storageBucket: "tamilgeoapp.appspot.com",
      messagingSenderId: "1092623024431",
      appId: "1:1092623024431:web:ea455dd68a9fcf480be1da",
      measurementId: "G-2D45G35PM2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const postId = new URLSearchParams(window.location.search).get("id");
    const postURL = `https://public-api.wordpress.com/wp/v2/sites/tamilgeo.wordpress.com/posts/${postId}`;
    const container = document.getElementById("post-container");

    fetch(postURL)
      .then(res => res.json())
      .then(post => {
        const image = post.jetpack_featured_media_url
          ? `<img src="${post.jetpack_featured_media_url}" class="w-full h-60 object-cover rounded-md mb-4">`
          : "";

        const contentWithResponsiveVideos = post.content.rendered.replace(
          /<iframe.*?<\/iframe>/g,
          match => `<div class="video-container aspect-video">${match}</div>`
        );

        container.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-2xl font-bold mb-2">${post.title.rendered}</h2>
            <div class="text-sm text-gray-500 mb-4">
              👤 Author: TamilGeo | 🗓️ ${new Date(post.date).toLocaleDateString()}
            </div>
            ${image}
            <div class="prose max-w-none mb-6">${contentWithResponsiveVideos}</div>

            <div class="mt-4 flex items-center gap-3">
              <button id="like-btn" class="bg-pink-500 text-white px-3 py-1 rounded hover:bg-pink-600">♥ Like (<span id="like-count">0</span>)</button>
              <button onclick="sharePost()" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">🔗 Share</button>
            </div>

            <div class="mt-6">
              <h3 class="font-semibold text-lg mb-2">💬 Comments</h3>
              <textarea id="comment-box" placeholder="Write a comment..." class="w-full p-2 border rounded mb-2"></textarea>
              <button id="comment-btn" class="bg-green-600 text-white px-3 py-1 rounded">Post Comment</button>
              <div id="comments" class="mt-4 space-y-2 text-sm text-gray-700"></div>
            </div>
          </div>
        `;

        setupFirebase();
      });

    function sharePost() {
      const url = window.location.href;
      navigator.clipboard.writeText(url);
      alert("🔗 Post link copied to clipboard!");
    }

    function setupFirebase() {
      const likeBtn = document.getElementById("like-btn");
      const likeCountSpan = document.getElementById("like-count");
      const commentBox = document.getElementById("comment-box");
      const commentBtn = document.getElementById("comment-btn");
      const commentsDiv = document.getElementById("comments");

      const likesRef = ref(db, `likes/post_${postId}`);
      const commentsRef = ref(db, `comments/post_${postId}`);

      // Get & show likes
      onValue(likesRef, snapshot => {
        likeCountSpan.textContent = snapshot.val() || 0;
      });

      // Like post
      likeBtn.addEventListener("click", () => {
        get(likesRef).then(snapshot => {
          const currentLikes = snapshot.val() || 0;
          set(likesRef, currentLikes + 1);
        });
      });

      // Load comments
      onValue(commentsRef, snapshot => {
        const data = snapshot.val();
        commentsDiv.innerHTML = "";
        if (data) {
          Object.values(data).forEach(comment => {
            commentsDiv.innerHTML += `<div class="bg-gray-100 p-2 rounded">${comment}</div>`;
          });
        }
      });

      // Add new comment
      commentBtn.addEventListener("click", () => {
        const text = commentBox.value.trim();
        if (text) {
          push(commentsRef, text);
          commentBox.value = "";
        }
      });
    }
  </script>

  <style>
    .video-container iframe {
      width: 100%;
      height: 100%;
    }
  </style>

  <!-- Header -->
  <header class="flex justify-between items-center bg-white shadow px-4 py-3 sticky top-0 z-50">
    <h1 class="text-2xl font-bold text-gray-800">TamilGeo</h1>
    <nav class="space-x-4">
      <a href="index.html" class="text-blue-600 hover:underline">Home</a>
      <a href="about.html" class="text-blue-600 hover:underline">About</a>
    </nav>
  </header>

  <!-- Post container -->
  <main class="max-w-3xl mx-auto p-4" id="post-container"></main>

  <!-- Back to Top -->
  <div class="fixed bottom-4 right-4">
    <button onclick="window.scrollTo({top:0,behavior:'smooth'})"
      class="bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-blue-700 transition">↑ Top</button>
  </div>
</body>
</html>