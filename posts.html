<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Approved Posts - TamilGeo</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">

  <!-- Shared Header -->
  <div id="shared-header"></div>

  <!-- Posts Grid -->
  <main
    id="posts-container"
    class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-grow max-w-7xl mx-auto"
  >
    <!-- Posts injected here -->
  </main>

  <!-- Firebase & Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      remove,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import {
      getAuth,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDt86oFFa-h04TsfMWSFGe3UHw26WYoR-U",
      authDomain: "tamilgeoapp.firebaseapp.com",
      databaseURL: "https://tamilgeoapp-default-rtdb.firebaseio.com",
      projectId: "tamilgeoapp",
      storageBucket: "tamilgeoapp.appspot.com",
      messagingSenderId: "1092623024431",
      appId: "1:1092623024431:web:ea455dd68a9fcf480be1da",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const postsRef = ref(db, "posts");
    const container = document.getElementById("posts-container");

    let isAdmin = false;
    let isLoggedIn = false;

    // Helper: strip HTML tags from strings
    function stripHTML(html) {
      const div = document.createElement("div");
      div.innerHTML = html;
      return div.textContent || div.innerText || "";
    }

    // Helper: time ago formatting
    function timeAgo(timestamp) {
      const now = new Date();
      const postDate = new Date(timestamp);
      const diff = Math.floor((now - postDate) / 1000);

      if (diff < 60) return "Just now";
      if (diff < 3600) return `${Math.floor(diff / 60)} mins ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)} hrs ago`;
      if (diff < 604800) return `${Math.floor(diff / 86400)} days ago`;

      return postDate.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric",
      });
    }

    // Edit & Delete handlers (for admin)
    window.editPost = (postId, title, content) => {
      alert(`Edit post: ${postId}\nTitle: ${title}\nContent: ${content}`);
      // TODO: add your edit modal or UI here
    };

    window.deletePost = async (postId) => {
      if (confirm("Are you sure you want to delete this post?")) {
        try {
          await remove(ref(db, "posts/" + postId));
          alert("Post deleted!");
          loadPosts();
        } catch (error) {
          alert("Error deleting post: " + error.message);
        }
      }
    };

    // Load and render approved posts with UI style like index.html
    function loadPosts() {
      onValue(postsRef, (snapshot) => {
        let postsArray = [];

        snapshot.forEach((childSnap) => {
          const post = childSnap.val();
          post.id = childSnap.key;
          postsArray.push(post);
        });

        // Filter only approved posts
        postsArray = postsArray.filter((p) => p.status === "approved");
        // Sort newest first
        postsArray.sort((a, b) => b.date - a.date);

        container.innerHTML = postsArray
          .map((post) => {
            const image = post.image
              ? `<img src="${post.image}" class="w-full h-40 object-cover rounded-t-md" alt="${post.title}" />`
              : `<div class="w-full h-40 bg-gray-200 flex items-center justify-center text-gray-400 rounded-t-md text-sm">No Image</div>`;

            // Excerpt limit: 100 chars max
            const excerpt = post.excerpt
              ? stripHTML(post.excerpt).slice(0, 100)
              : post.content
              ? stripHTML(post.content).slice(0, 100)
              : "";
            const excerptDisplay = excerpt.length === 100 ? excerpt + "..." : excerpt;

            // Author full name fallback
            const authorName = post.author || "Unknown";

            // Time ago format
            const postedAgo = timeAgo(post.date);

            // Admin controls (edit/delete)
            const adminControls = isAdmin
              ? `<div class="mt-3 flex gap-2">
                  <button
                    onclick="editPost('${post.id}', \`${post.title.replace(/`/g, "\\`")}\`, \`${(post.content || "").replace(/`/g, "\\`")}\`)"
                    class="bg-yellow-500 text-white px-3 py-1 rounded text-sm flex items-center gap-1"
                    ><i class="fa fa-edit"></i> Edit</button
                  >
                  <button
                    onclick="deletePost('${post.id}')"
                    class="bg-red-500 text-white px-3 py-1 rounded text-sm flex items-center gap-1"
                    ><i class="fa fa-trash"></i> Delete</button
                  >
                </div>`
              : "";

            return `
            <div class="relative group">
              <a href="post-view.html?id=${post.id}" class="block bg-white rounded-lg overflow-hidden shadow hover:shadow-lg transition duration-300 transform hover:-translate-y-1 card">
                ${image}
                <div class="p-4 flex flex-col flex-grow">
                  <h2 class="text-lg font-bold mb-2">${post.title}</h2>
                  <p class="text-sm text-gray-600 mb-2 flex-grow">${excerptDisplay}</p>
                  <div class="flex justify-between text-xs text-gray-500 mt-auto">
                    <span>üë§ ${authorName}</span>
                    <span>üóìÔ∏è ${postedAgo}</span>
                  </div>
                </div>
              </a>
              ${adminControls}
            </div>`;
          })
          .join("");
      });
    }

    // Check user auth and role then load posts
    onAuthStateChanged(auth, async (user) => {
      isLoggedIn = !!user;

      if (user) {
        try {
          const userSnap = await get(ref(db, "users/" + user.uid));
          isAdmin = userSnap.exists() && userSnap.val().role === "admin";
        } catch {
          isAdmin = false;
        }
      } else {
        isAdmin = false;
      }

      loadPosts();
    });
  </script>

  <!-- Header -->
  <script type="module" src="header.js"></script>

  <!-- Footer -->
  <footer id="footer" class="mt-auto"></footer>
  <script type="module" src="js/footer.js"></script>
</body>
</html>